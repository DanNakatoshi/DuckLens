# Portfolio Optimization & Rebalancing System

## Overview

This document describes the comprehensive portfolio optimization and rebalancing system integrated into DuckLens. The system helps you maximize returns by:

1. **Identifying underperforming holdings** that should be reduced or exited
2. **Finding better opportunities** with stronger signals
3. **Optimizing cash allocation** with intelligent position sizing
4. **Managing margin usage** with conservative risk rules
5. **Tracking all signals** to measure what works and what doesn't
6. **Backtesting strategies** before deploying them live

---

## System Architecture

### Core Components

#### 1. **SignalTracker** (`src/tracking/signal_tracker.py`)
Records every trading signal (buy/sell/hold) generated by the system.

**Key Features:**
- Tracks signal strength, confidence, price levels
- Records whether you acted on the signal
- Measures actual outcomes (WIN/LOSS/MISSED)
- Calculates win rates, profit factors, missed opportunities

**Database Table:** `trading_signals`

#### 2. **PortfolioAnalyzer** (`src/analysis/portfolio_analyzer.py`)
Analyzes your current holdings and finds optimization opportunities.

**Key Features:**
- Calculates performance metrics for each holding
- Compares vs SPY benchmark (alpha calculation)
- Identifies underperformers (weak signals, negative alpha)
- Screens watchlist for better alternatives
- Generates specific swap recommendations

#### 3. **PositionSizer** (`src/allocation/position_sizer.py`)
Calculates optimal position sizes based on signal strength and risk.

**Position Sizing Rules:**
- **Signal 80-100:** 15-20% of portfolio (LARGE position)
- **Signal 70-79:** 10-15% of portfolio (MEDIUM position)
- **Signal 60-69:** 5-10% of portfolio (SMALL position)
- **Signal 50-59:** 3-5% of portfolio (MINIMAL position)
- **Signal <50:** Skip or watch

**Margin Rules (Conservative):**
- Only use margin for signals >75 strength
- Max 25% of portfolio value in margin
- Require 30%+ cash reserve
- Prefer cash-only positions

#### 4. **StrategyBacktest** (`src/backtest/strategy_backtest.py`)
Tests the rebalancing strategy on historical data.

**Backtests Strategies:**
- Buy & hold (no rebalancing)
- Weekly rebalancing, no margin
- Monthly rebalancing, no margin
- Monthly rebalancing, with margin

**Metrics Calculated:**
- Total return vs SPY
- Alpha (excess return over market)
- Maximum drawdown
- Sharpe ratio (risk-adjusted return)
- Win rate, avg holding period

---

## How It Works

### Morning Workflow

When you run `.\tasks.ps1 morning-check`, the system now includes:

1. **Account Balance Summary**
   - Cash, portfolio value, total
   - Buying power, margin usage
   - Risk level assessment

2. **Market Direction** (SPY/QQQ signals)

3. **Portfolio Status** (your current holdings)

4. **Watchlist Opportunities** (new buy signals)

5. **🆕 PORTFOLIO OPTIMIZATION** (new section!)
   - Portfolio health score (A-F grade)
   - Average alpha vs SPY
   - Average signal strength across holdings
   - Issues detected (underperformers, weak signals)
   - Specific rebalancing recommendations:
     * **REDUCE:** Underperforming position
     * **INCREASE:** Better opportunity
     * Expected improvement (points gained)
     * Suggested position size
     * Risk level & margin usage

6. **Game Plan** (action items for the day)

### Intraday Workflow

When you run `.\tasks.ps1 intraday`, the system now includes:

1. **Account Summary**

2. **Market Direction** (real-time)

3. **Morning Buy Signals** (status check)

4. **Your Holdings** (sell check)

5. **New Buy Signals** (emerged today)

6. **🆕 REBALANCING ALERTS** (new section!)
   - Quick check for underperformers
   - Flags positions with negative alpha or weak signals
   - Suggests reviewing full optimization in morning check

7. **Final Decision**

---

## Example Scenarios

### Scenario 1: Swap Underperformer for Better Opportunity

**Morning Check Output:**
```
>> PORTFOLIO OPTIMIZATION - Rebalancing Opportunities

Portfolio Health: B (75/100) | Average alpha: +2.3% vs SPY

Recommendation #1:

┌──────────┬────────┬────────────────┬────────────────┬──────────────────────────────────┐
│          │ Symbol │ Value/Price    │ Signal         │ Reason                           │
├──────────┼────────┼────────────────┼────────────────┼──────────────────────────────────┤
│ REDUCE   │ XYZ    │ $5,240.00      │ 38/100         │ Underperforming SPY by 4.2%      │
│ INCREASE │ ABC    │ $125.50        │ 82/100         │ Strong signal (82/100), UP trend │
└──────────┴────────┴────────────────┴────────────────┴──────────────────────────────────┘

Expected Improvement: +44 points
Risk Level: LOW
Suggested Size: 45 shares ($5,647.50, 18.8% of portfolio)
```

**Your Action:**
1. Sell XYZ (underperforming, weak signal)
2. Buy ABC (strong signal, uptrend)
3. Net result: Upgrade signal strength by 44 points

### Scenario 2: No Rebalancing Needed

**Morning Check Output:**
```
>> PORTFOLIO OPTIMIZATION - Rebalancing Opportunities

Portfolio Health: A (92/100) | Average alpha: +8.5% vs SPY

✓ No rebalancing needed - portfolio is well optimized
```

**Your Action:**
- Hold current positions
- No changes needed today

### Scenario 3: Intraday Alert

**Intraday Monitor Output:**
```
=== PORTFOLIO REBALANCING ALERTS ===

⚠️  2 position(s) flagged for review:

┌────────┬──────────────┬──────────┬──────────┬────────────────────┐
│ Symbol │ Value        │ Alpha    │ Signal   │ Action             │
├────────┼──────────────┼──────────┼──────────┼────────────────────┤
│ DEF    │ $3,450.00    │ -3.8%    │ 42/100   │ Consider reducing  │
│ GHI    │ $4,120.00    │ -1.2%    │ 48/100   │ Consider reducing  │
└────────┴──────────────┴──────────┴──────────┴────────────────────┘

Review full optimization in morning check for swap recommendations
```

---

## Database Schema

### trading_signals Table

Tracks all signals and their outcomes.

```sql
CREATE TABLE trading_signals (
    id INTEGER PRIMARY KEY,
    signal_date DATE NOT NULL,
    signal_time TIMESTAMP NOT NULL,
    symbol VARCHAR(10) NOT NULL,
    signal_type VARCHAR(10) NOT NULL,      -- BUY, SELL, HOLD
    signal_source VARCHAR(50) NOT NULL,    -- morning_check, intraday_monitor

    signal_strength DECIMAL(5, 2),         -- 0-100 score
    confidence_level VARCHAR(20),          -- HIGH, MEDIUM, LOW

    price_at_signal DECIMAL(18, 4),
    target_entry DECIMAL(18, 4),
    target_exit DECIMAL(18, 4),
    stop_loss DECIMAL(18, 4),

    rsi_value DECIMAL(10, 2),
    macd_value DECIMAL(10, 4),
    volume_ratio DECIMAL(10, 2),
    trend_direction VARCHAR(10),

    current_position_size DECIMAL(18, 2),
    suggested_action VARCHAR(50),          -- ENTER, ADD, REDUCE, EXIT, SWAP
    suggested_quantity INTEGER,
    suggested_allocation_pct DECIMAL(5, 2),

    use_margin BOOLEAN DEFAULT FALSE,
    margin_requirement DECIMAL(18, 2),
    risk_level VARCHAR(20),

    action_taken BOOLEAN DEFAULT FALSE,    -- Did you take this signal?
    actual_entry_date DATE,
    actual_entry_price DECIMAL(18, 4),
    actual_quantity INTEGER,

    max_profit_potential DECIMAL(18, 2),   -- What could have happened
    actual_profit DECIMAL(18, 2),          -- What did happen
    days_held INTEGER,
    outcome VARCHAR(20),                   -- WIN, LOSS, BREAKEVEN, MISSED

    notes TEXT
);
```

### rebalancing_recommendations Table

Tracks portfolio rebalancing suggestions.

```sql
CREATE TABLE rebalancing_recommendations (
    id INTEGER PRIMARY KEY,
    recommendation_date TIMESTAMP NOT NULL,

    total_portfolio_value DECIMAL(18, 2),
    cash_available DECIMAL(18, 2),
    margin_available DECIMAL(18, 2),

    action_type VARCHAR(20),               -- SWAP, REDUCE, INCREASE
    symbol_to_reduce VARCHAR(10),
    symbol_to_increase VARCHAR(10),

    reduce_quantity INTEGER,
    increase_quantity INTEGER,
    reduce_reason TEXT,
    increase_reason TEXT,

    expected_improvement_pct DECIMAL(10, 2),
    risk_score DECIMAL(5, 2),

    executed BOOLEAN DEFAULT FALSE,        -- Did you execute this?
    execution_date TIMESTAMP,
    actual_improvement_pct DECIMAL(10, 2), -- Actual result

    notes TEXT
);
```

---

## Using the System

### 1. Morning Routine (9 AM)

```powershell
.\tasks.ps1 morning-check
```

**Review:**
- Account balance and buying power
- Portfolio health score
- Rebalancing recommendations
- Buy candidates

**Decision:**
- Execute recommended swaps?
- Take profit on winners?
- Add to positions?

### 2. Intraday Check (3 PM)

```powershell
.\tasks.ps1 intraday
```

**Review:**
- Morning signals - still valid?
- New opportunities emerged?
- Any positions flagged for review?

**Decision:**
- Execute any trades before market close

### 3. View Signal History

```powershell
poetry run python scripts/view_signal_history.py
```

**Shows:**
- Win rate (90 days, 30 days)
- Total P&L
- Profit factor
- Signals by source
- Recent signals
- Missed opportunities

### 4. Run Backtest

```powershell
poetry run python scripts/run_backtest.py
```

**Tests:**
- Buy & hold vs rebalancing
- Different rebalancing frequencies
- Margin vs no margin
- Shows which strategy performs best

---

## Performance Metrics

### Portfolio Health Score

Calculated from:
- **Alpha vs SPY** (30 points): Beating the market?
- **Signal Strength** (40 points): Holdings still strong?
- **Diversification** (30 points): Too many underperformers?

**Grade:**
- **A (90-100):** Excellent, portfolio optimized
- **B (80-89):** Good, minor optimization possible
- **C (70-79):** Fair, some issues to address
- **D (60-69):** Poor, needs attention
- **F (<60):** Critical, major rebalancing needed

### Signal Strength

Based on technical indicators:
- **RSI:** Oversold (good) vs overbought (bad)
- **MACD:** Positive momentum vs negative
- **Trend:** Uptrend vs downtrend
- **Recent Performance:** Winning vs losing

**Interpretation:**
- **80-100:** Very strong, consider large position
- **70-79:** Strong, medium position
- **60-69:** Moderate, small position
- **50-59:** Weak, minimal position
- **<50:** Very weak, skip or exit

### Alpha

**Alpha = Your Return - SPY Return**

- **Alpha > 5%:** Crushing it! Strategy working
- **Alpha 0-5%:** Beating market, good job
- **Alpha -5-0%:** Slightly underperforming, optimize
- **Alpha < -5%:** Significantly underperforming, change strategy

---

## Risk Management

### Cash Allocation Rules

1. **Never go all-in** - Keep 20-30% cash reserve
2. **Position sizing** based on signal strength
3. **Diversification** - Min 5 positions, max 25% per stock
4. **Risk/reward** - Only take trades with R/R > 2:1

### Margin Rules (Conservative)

✅ **Use margin when:**
- Signal strength > 75
- Current margin < 25% of portfolio
- Cash reserve > 30%
- Confirmed bull market

❌ **Don't use margin when:**
- Signal strength < 75
- Already at 25% margin
- Cash reserve < 30%
- Market in correction

### Stop Loss Strategy

1. **Technical stop:** Break of support level
2. **Percentage stop:** -7% to -10% max loss
3. **Time stop:** Hold only while signal remains strong
4. **Portfolio stop:** Exit if underperforming SPY by >5%

---

## Backtesting Strategy

### Before Going Live

**Always backtest first:**

```powershell
poetry run python scripts/run_backtest.py
```

**Validation Criteria:**
- Alpha > 3% (beating SPY by meaningful amount)
- Sharpe > 1.0 (good risk-adjusted returns)
- Max drawdown < 20% (tolerable losses)
- Win rate > 55% (more winners than losers)

### Test Different Parameters

Modify `run_backtest.py` to test:
- Different rebalancing frequencies (7, 14, 30, 60 days)
- Different signal strength thresholds
- Different position sizes
- Different margin limits

### Paper Trade First

1. Run morning/intraday checks
2. Record recommendations
3. Track hypothetical performance for 30 days
4. Compare actual results vs expected
5. Only go live if backtest + paper trading confirm edge

---

## Troubleshooting

### "No rebalancing recommendations"

**Causes:**
- Portfolio already optimized
- No better opportunities available
- All holdings performing well

**Action:** This is good! Hold positions.

### "Portfolio Health: F"

**Causes:**
- Multiple underperformers
- Negative average alpha
- Weak signal strength across holdings

**Actions:**
1. Review each position individually
2. Check if market regime changed
3. Consider exiting worst performers
4. Rebuild portfolio with stronger signals

### "Error analyzing portfolio"

**Causes:**
- Missing technical indicators data
- Database connection issue
- Holdings file corrupted

**Actions:**
1. Update indicators: `.\tasks.ps1 update-daily`
2. Check database: `poetry run python scripts/db_check.py`
3. Verify holdings file exists

---

## Best Practices

### 1. Daily Routine

**Morning (9 AM):**
- Review morning check
- Note rebalancing recommendations
- Plan day's trades

**Intraday (3 PM):**
- Check intraday monitor
- Execute planned trades
- Record any new signals

**After Close:**
- Update cash balance
- Update portfolio if trades executed
- Review day's performance

### 2. Weekly Review

**Every Sunday:**
- View signal history
- Check win rate trends
- Review missed opportunities
- Adjust strategy if needed

### 3. Monthly Analysis

**First of Month:**
- Run backtest on recent period
- Compare actual vs expected performance
- Calculate to $1M timeline
- Adjust position sizing if needed

### 4. Continuous Improvement

**Track Everything:**
- Record why you took/skipped signals
- Note what worked and what didn't
- Adjust signal strength thresholds
- Refine entry/exit timing

---

## Advanced Topics

### Custom Signal Strength Calculation

Edit `src/analysis/portfolio_analyzer.py`:

```python
def _calculate_signal_strength(self, rsi, macd_hist, trend, return_pct):
    strength = 50  # Base

    # Customize weights:
    # RSI: 30 points -> Change to 40?
    # MACD: 20 points -> Change to 30?
    # Trend: 20 points -> Keep same
    # Performance: 30 points -> Change to 20?

    # Add your own indicators:
    # Volume, Bollinger Bands, etc.

    return max(0, min(100, strength))
```

### Custom Position Sizing

Edit `src/allocation/position_sizer.py`:

```python
def calculate_position_size(self, signal_strength, risk_level, price, use_margin):
    # Change allocation percentages:
    if signal_strength >= 90:  # Was 80
        base_allocation = 0.25  # Was 0.20 (20% -> 25%)

    # Change risk multipliers:
    risk_multiplier = {
        "LOW": 1.5,    # Was 1.2
        "MEDIUM": 1.0,
        "HIGH": 0.5    # Was 0.7
    }

    # Add Kelly Criterion:
    # kelly_pct = (win_rate * avg_win - avg_loss) / avg_win
    # allocation = min(base_allocation, kelly_pct)
```

### Custom Margin Rules

Edit `src/allocation/position_sizer.py`:

```python
def _should_use_margin(self, signal_strength):
    # More aggressive:
    if signal_strength < 70:  # Was 75
        return False

    if current_margin_pct >= 40:  # Was 25
        return False

    if cash_pct < 20:  # Was 30
        return False

    return True
```

---

## API Reference

### SignalTracker

```python
from src.tracking.signal_tracker import SignalTracker

with SignalTracker() as tracker:
    # Record signal
    signal_id = tracker.record_signal(
        symbol="AAPL",
        signal_type="BUY",
        signal_source="morning_check",
        signal_strength=75.0,
        price_at_signal=150.25,
        notes="Strong uptrend"
    )

    # Mark as taken
    tracker.mark_signal_taken(
        signal_id=signal_id,
        actual_entry_price=150.50,
        actual_quantity=10
    )

    # Update outcome
    tracker.update_signal_outcome(
        signal_id=signal_id,
        actual_profit=125.50,
        days_held=15,
        outcome="WIN"
    )

    # Get stats
    stats = tracker.get_signal_win_rate(lookback_days=90)
    print(f"Win rate: {stats['win_rate_pct']:.1f}%")
```

### PortfolioAnalyzer

```python
from src.analysis.portfolio_analyzer import PortfolioAnalyzer

analyzer = PortfolioAnalyzer()

# Portfolio health
health = analyzer.get_portfolio_health_score()
print(f"Grade: {health['grade']} ({health['score']}/100)")

# Find underperformers
underperformers = analyzer.find_underperformers()

# Find opportunities
opportunities = analyzer.find_better_opportunities(watchlist)

# Generate swaps
swaps = analyzer.generate_swap_recommendations(watchlist)
```

### PositionSizer

```python
from src.allocation.position_sizer import PositionSizer

sizer = PositionSizer(
    total_capital=30000,
    cash_balance=10000,
    margin_available=20000,
    current_margin_used=0
)

# Calculate position
position = sizer.calculate_position_size(
    signal_strength=75.0,
    risk_level="MEDIUM",
    price=150.00,
    use_margin=False
)

print(f"Buy {position['quantity']} shares")
print(f"Allocation: {position['allocation_pct']:.1f}%")
```

---

## FAQ

**Q: How often should I rebalance?**
A: Monthly is recommended. Weekly if very active trader.

**Q: Should I use margin?**
A: Only for very high confidence signals (>75) and conservative limits.

**Q: What if backtest shows negative alpha?**
A: Don't use that strategy! Optimize or switch to buy & hold.

**Q: Can I customize the signal strength calculation?**
A: Yes! Edit `_calculate_signal_strength()` in `portfolio_analyzer.py`.

**Q: How do I track manual trades?**
A: Use `SignalTracker.record_signal()` and `mark_signal_taken()`.

**Q: What's a good portfolio health score?**
A: B or higher (80+). Below that, review and rebalance.

---

## Support

For issues or questions:
1. Check logs in `logs/` directory
2. Run diagnostic: `poetry run python scripts/db_check.py`
3. View signal history: `poetry run python scripts/view_signal_history.py`
4. Open issue on GitHub

---

**Happy Trading! 📈🚀**
